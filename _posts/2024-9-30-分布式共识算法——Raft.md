# 1、基本概念

Raft涉及的关键术语分为3个方面，即成员状态、运行阶段和RPC消息

## 1.1、多数派

多数派接收某一个日志项，即意味着整个集群接收该日志项

## 1.2、任期

Raft将任期分割为不同长度的任期，记作term。term使用连续的整数进行单数递增，并随着RPC消息在成员间交换。

Raft使用term作为Leader的任期号并遵循以下规则：

- 每个Raft成员在本地维护自己的term
- 在每轮Leader选举之前递自己本地的term
- 每个RPC消息都携带自己本地的term
- 每个Raft成员拒绝处理小于自己本地term的RPC消息

如果一个Candidate或者Leader发现自己额term小于接收消息中的term，则会立即回到Follower状态

Raft允许新旧多个Leader同时存在，需要通过term拒绝哪些过期的Leader

## 1.3、成员状态

![](../images/2024-9-30-分布式共识算法——Raft/成员角色转换.png)

### Follower

- 只会处理和响应来自Leader和Candidate的请求。如果一个客户端和Follower通信，Follower会将请求重定向给Leader。
- 数据以Leader为准，被动接收

### Candidate

- 如果Leader出现故障或者Follower等待心跳超时，则Follower会变更为Candidate
- 新的Leader只会从Candidate中产生

### Leader

- 当某个Candidate获得多数派选票时，该成员晋升为Leader负责处理接下来的客户端请求、日志复制和心跳消息管理

### 无投票成员

- 新成员上线时的的身份，在不影响集群情况下快速和Leader进行数据对齐。

### Witness

- 只投票不存储数据放入成员对资源需求小

## 1.4、运行阶段

### Leader选举

集群启动之初或Leader出现故障时，需要选出一个新Leader接替上一任Leader工作

### 日志复制

Leader可以接受客户端请求并进行正常处理，有Leader向Folloer同步日志项

## 1.5、RPC消息

RPC消息分为四种，前两种事Raft基础功能的实现，后两种是为了优化Raft引入的

- RequstVote：请求投票信息
- AppendEntries：追加条目信息。用于一下场景
  - Leader用该消息向Folloer执行日志复制
  - Leader与Follower之间的心跳检测
  - Leader与Follower之间的日志对齐
- InstallSnapshot：快照传输消息
- TimeoutNow：快速超时消息，用于Leader切换，可立即发起Leader选举

# 2、算法描述

## 2.1、Leader选举

### 2.1.1、选举进程

- Follower在等待一个超时后进入Candidate状态，然后发起Leader选举并通过RequestVote消息广播自己的选票（包含最新日志索引和任期term）
- 当发生以下情况退出Candidate状态
  - 自己获得多数派选票赢得本次选举，进入Leader状态
  - 其它成员获得多数派选票，进入Follower状态
  - 在一段时间内，灭有任何成员获得多数派选票
- 采用先来先服务规则
  - 当成员A收到B和C同一任期的选票，且成员B的选票先到，则在该任期内A会将选票投给成员B
- 当一个Candidatee当选时，进入Leader状态会周期向所有Follower发起心跳消息（AppendEntries消息），防止Follower发起新的选举
- 当一个Candidate在等待选票过程中收到AppendEntries消息。且任期大于等于自己任期时，进入Follower状态
  - 如果小于自己任期，拒绝该消息继续选举

### 2.1.2、分割选举

多个Candidate发起选举，选票被瓜分

#### 双重等待机制

- 随机等待心跳超时：降低多个成员同时发起选举的可能性
- 随机等待选票超时：控制同时发起选举的成员数量

### 2.1.3、投票规则

Raft试图保证在选举阶段新晋升的Leader一定拥有之前提交的所有日志

- 任期长的成员拒绝给任期短的成员投票
- 最后一条日志项编号大成员拒绝给日志项小的成员投票
- 每个成员任期内只能都出一张票，先来先服务

## 2.2、日志复制

### 2.2.1、日志项

- 日志是一个无限长的列表，每个元素是一个日志项。日志项保存事务操作、term和日志索引
- Raft日志必须是连续的，不允许出现空洞

### 2.2.2、日志复制

Leader与Follower交互步骤

- Leader首先以日志项的形式将事务追加到本地日志
- Leader并行地通过AppendEndtries消息将日志广播给Follower
- Follower按照AppendEndtries消息将日志追加至本地日志
- Follower将执行结果发送给Leader
- Leader收到多数派的Follower成功响应就立即提交日志
- Leaer将执行结果返回给客户端

Follower接受条件

- 接收某个日志项前检查是否已经拥有前一个日志项

### 2.2.3、日志提交

Leader发送心跳AE消息或下一个日志协商AE的消息通知Follower提交日志

#### committedIndex

已经达成共识的日志索引，Leader在与Follower交互中携带这个变量，在Follower中系哦小于或等于该变量的日志均可提交

































