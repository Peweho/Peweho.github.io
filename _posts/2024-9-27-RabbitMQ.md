# 集群

## 架构

RabbitMQ会始终记录以下四种类型的内部元数据

- 队列元数据——队列名称和它的属性（是否可持久化，是否自动删除？）
- 交换器元数据——交换器名称、类型和属性
- 绑定元数据——保存如何将消息路由到消息队列
- vhost元数据——为vhost内的队列，交换器和绑定提供命名空间和安全属性

### 集群中的队列

每一个节点并不拥有所有队列的拷贝，原因：

- 存储空间——添加新的节点不会带来更多的存储空间
- 性能——消息的发布需要复制到每一个几点。对于需要持久化的消息还有磁盘活动。每次新增节点，都会增加网络和磁盘的活动

集群中只有唯一结点负责特定队列，其他节点需要将接收到的该队列的信息传递给该队列的所有者节点。

### 分布式交换器

- 交换器实质是一个名称和一个队列绑定列表

- 当消息发送到交换器时，实际上有你所连接额信道将消息上的路由键同交换器的绑定列表进行比较，然后路由信息。
- 因此交换器在集群的所有节点上

#### 作用

- 如果有节点故障时，不需要重新声明交换器，只需要让故障节点上的消费者重新连接到集群上，它们立即可以发送消息
- AMQP、发送方确认模式，需要判断是否可以路由到目标节点，交换器就可以检测是否可路由

### 内存节点和磁盘节点

集群的节点要么是内存节点，要么是磁盘节点

- 内存结点：所有元数据保存在内存。提供性能
- 磁盘节点：所有元数据保存在磁盘中，单节点只允许磁盘节点。保障集群的配置信息

要求集群中至少有一个磁盘节点。其他可以是内存节点

如果唯一一个磁盘节点故障，集群可以继续路由，但不能有以下操作：

- 创建队列、交换器、绑定关系
- 添加用户
- 更改权限
- 添加或删除集群节点                                                                                                                                                                                                                                                                                                                                              





